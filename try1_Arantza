 library(LabApplStat)
library(lme4)
library(MASS)
library(emmeans)

yield <- read.delim("dataM.txt")
summary (yield)
str(yield)

plot(DD(yield~ pd * environment * genotype, random=~environment:pd: block: rep,data=yield),"MSS")
plot(DD(yield~ pd * environment * genotype, random=~environment:pd: block: rep,data=yield))
m0 <- lmer(yield ~ pd * environment * genotype + (1|environment:pd:block:rep), data = yield)
#see which variables have effects 
#environment:pd:block:rep
names(ranef(m0))

# Residual plot
plot(m0) #looks ok 

# Normal quantile plot for residuals
qqnorm(residuals(m0))
qqline(residuals(m0))   # to add the line
# Normal quantile plot for random effects
qqnorm(ranef(m0)[["environment:pd:block:rep"]][, 1], asp = 1)
qqline(ranef(m0)[["environment:pd:block:rep"]][, 1], asp = 1)   # to add the line
#check that residuals are normally distributed with Shapiro test
# p-value of 3.221*10^-7 so residuals are not normally distributed which would mean we could do a Box-Cox transformation??
shapiro.test(residuals(m0))
#based on the result of the boxcox, I think it is very close to 1, so idk if it would be good to do the transformation
boxcox(lm(yield ~ pd * environment * genotype,data=yield),lambda = seq(-3,2,0.1))


"""
our disrtibution looks good, no apparent outliers and no special trends or 
patterns followed by the observations. QQ plot looks almost perfect for residuals, but a bit
questionable for random effects

"""

# now we move on to the model reduction
# our model:
# m0 <- lmer(yield ~ pd * environment * genotype + (1|environment:pd:block:rep), data = yield)

drop1(m0)

# interaction pd:environment:genotype can be deleted
m1 <- update(m0, . ~ . - pd:environment:genotype)
drop1(m1)

# interaction pd:genotype can be deleted
m2 <- update(m1, . ~ . - pd:genotype)
drop1(m2)

#Since AIC of /none/ is the lowest, we stop reducing it, this meaning:
# WE FOUND THE MINIMAL ADEQUATE MODEL:
m2  <- lmer(yield ~ pd + environment + genotype + pd:environment + environment:genotype + (1 | environment:pd:block:rep), data = yield)
# NOW WE TEST validity OF THE MODEL with the reduction

# Residual plot
plot(m2)
# Normal quantile plot for residuals
qqnorm(residuals(m2))
qqline(residuals(m2))   # to add the line
# Normal quantile plot for random effects
qqnorm(ranef(m2)[["environment:pd:block:rep"]][, 1], asp = 1)
qqline(ranef(m2)[["environment:pd:block:rep"]][, 1], asp = 1)   # to add the line

# model fits even better than in the beginning 
# ARE THERE EFFECTS??

# Interaction comparisons (pd × environment)
# Within each environment, what is the expected mean yield for each planting date, averaged over genotypes?
emmeans(m2, ~ pd | environment)
#Are those differences statistically meaningful within each environment?
pairs(emmeans(m2, ~ pd | environment))

" In Fumesua, yield differed significantly among all three plant densities
(high > medium > low). In Legon_Mi, high density produced significantly higher
yields than both medium and low densities, whereas the difference between medium 
and low densities was not significant. A similar pattern was observed in Legon_off. 
In Nyankpala, medium density yielded significantly more than low density, while no 
significant differences were detected between high and medium or between high and low densities.
"
emmip(m2, pd ~ environment)


# Interaction comparisons (genotype × environment)
emmeans(m2, ~ genotype | environment)
pairs(emmeans(m2, ~ genotype | environment))

"Fumesua

Genotype performance differed significantly in Fumesua. The highest yields were 
observed for CML16 × 87036 and ENT11 × 87036, which formed the top statistical group. 
Several other genotypes, including PAN53 and M131 x CML16, showed comparable performance 
and did not differ significantly from the top group. Pairwise comparisons confirmed that high-performing 
genotypes yielded significantly more than the lowest-yielding genotypes.

Legon_Mi

In Legon_Mi, significant differences among genotypes were also observed. Hybrids
M131 x CML16 and TZdEI501 x ENT11 ranked among the highest yielding entries, whereas 
TZEI1-based genotypes were among the lowest. However, differences among the 
top-performing genotypes were generally not significant, indicating similar yield 
potential within this group.


Legon_off

Genotype rankings in Legon_off followed a pattern similar to Legon_Mi, with 
CML16-derived hybrids showing superior performance. Several genotypes formed a broad 
high-yielding group, while TZEI1-based genotypes consistently produced lower yields.
These results highlight moderate genotype differentiation within this environment.


Nyankpala

In Nyankpala, genotype performance differed markedly from the other environments. 
Overall yields were lower, and genotype rankings changed substantially. Although 
some genotypes maintained intermediate performance, no single genotype consistently 
dominated. Pairwise comparisons indicated fewer significant differences among genotypes, 
suggesting a stronger environmental constraint on yield expression.
"
emmip(m2, genotype ~ environment)
 



